# 6. 锁

锁定资源的能力提供了一种序列化访问该资源的机制. 作者客户端在使用锁后,
可以合理地保证另一个主体在编辑资源时不会修改这个资源.
通过这种方式, 客户端可以防止 "丢失更新" 问题.

本规范允许锁根据两个客户端指定的参数变化, 即涉及的主体数量 (独占 vs. 共享) 和要授予的访问类型.
本文仅为一种访问类型 (写入) 定义锁. 但是语法是可扩展的, 并允许最终指定其他访问类型的锁.

## 6.1. Model 锁

本章提供锁行为的简洁模型. 后续部分将参考这些模型语句并更详细地讨论一些概念.
与 LOCK 和 UNLOCK 方法处理相关的规范性可以在它们相关章节部分找到,
而涵盖任意方法的规范性陈述在这里进行汇总.

1. 一个锁可以直接或间接锁定资源.
2. 当对资源的 URL 发出 LOCK 请求以创建新的锁时, 资源将被直接锁定.
   新锁的 "lock-root" 是该 URL. 如在请求时 URL 没有映射到资源,
   一个新的空资源将被创建并直接锁定.
3. 互斥锁 ([第 6.2 节][SECTION#6.2]) 与同一资源上的任何其他类型的锁 (无论是直接还是间接)
   都会发生冲突. 服务器**不得[MUST_NOT]**在资源上创建互相冲突的锁.
4. 对使用 `深度无限锁 L` 锁定的集合, 所有成员资源都会被间接锁定.
   此类集合成员的关系变更会影响间接锁定资源的集合:
   - 如果将成员资源添加到集合中, 则新的成员资源**不能[MUST_NOT]**有任何具有冲突的锁,
     因为新资源**必须[MUST]**被 L 间接锁定.
   - 如果某个成员资源不再是集合成员, 则该资源**必须[MUST]**不再被 L 间接锁定.
5. 每个锁都由单一的全局唯一锁令牌 ([第 6.5 章][SECTION#6.5]) 标识。
6. UNLOCK 请求会删除具有指定锁定令牌的锁. 删除锁定后，没有资源被该锁锁定.
7. 锁令牌在请求中被 "提交" 时, 会出现在 "If" 标头中
   ([第 7 章][SECTION#7]中 "写锁" 讨论了何时需要为写锁提交令牌).
8. 如果请求会导致任何锁的锁根变为未映射的 URL, 那么该请求也**必须[MUST]**删除该锁.

## 6.2. 互斥锁 vs. 共享锁

锁最基本的形式是互斥锁. 互斥锁避免了处理内容时需要更改冲突的需求,
除了本规范中描述的方法之外不需要任何协调.

然而，有时锁的目标并不是排除其他人的访问权限, 而是提供一种机制, 供主体指示其访问权限.
共享锁因此被提出. 共享锁允许多个主体接收锁.
因此, 任何具有访问权限和有效锁的主体都可以使用被锁定的资源.

使用共享锁时, 存在影响资源的两个信任集 (trust sets). 第一个信任集由访问权限创建.
受信任的主体可能具有写入资源的权限. 在那些具有写入资源访问权限的人中,
已获取共享锁的主体也必须互相信任, 从而在访问权限写入集合内创建一个 (通常) 较小的信任集.

从互联网上的每个可能主体开始, 大多数情况下, 这些主体中的大多数不具有写入给定资源的访问权限.
在具有写入访问权限的少数主体中, 某些主体可能决定使用互斥写入锁来保证他们的编辑不会被覆盖.
另一些人可能会决定那些信任的合作者不会覆盖他们的工作 (潜在的合作者是具有写入许可的主体集),
并因此使用共享锁, 这会通知他们的合作者可能正在处理资源.

HTTP 的 WebDAV 扩展不需要提供主体协调其活动所需的所有通信路径. 在使用共享锁时,
主体可以使用任何带外通信通道 (out-of-band communication channel) 来协调他们的工作
(e.g., 面对面交流, 书面笔记, 屏幕上的便签, 电话访谈, 电子邮件等).
共享锁的目的是让合作者知道还有谁可能在处理该资源.

共享锁的引入是因为 Web 分布式作者系统的经验表明, 互斥锁通常过于僵化.
互斥锁用于强制执行特定的编辑过程: 获取独占锁, 读取资源, 执行编辑, 写入资源, 释放该锁.
这种编辑过程存在一个问题, 即锁不一定总被正确释放,
例如, 当程序崩溃或锁创建者离开而没有解锁资源时.
虽然超时 ([第 6.6 章][SECTION#6.6]) 和管理员操作都可以用来移除有问题的锁,
但在有需要时两者可能都不可用; 超时可能很长, 或者管理员可能不在.

对于成功的请求来说, 新的共享锁**必须[MUST]**导致生成与请求主体关联的唯一锁.
因此, 如果有五个主体在同一资源上获取了共享写锁, 那么将有五个锁和五个锁令牌, 每个主体一个.

## 6.3. 所需支持

WebDAV 兼容的资源不需要以任何形式支持锁. 如果资源支持锁,
其可以选择支持任何访问类型的互斥锁和共享锁的任何组合.

设计这种灵活性的原因在于, 锁策略涉及到各种存储库所采用的资源管理和版本控制系统的核心.
这些存储库需要控制自己能够提供哪种类型的锁. 例如, 一些存储库仅支持共享写锁,
而另一些仅支持独占写锁, 而另一些则根本不使用锁. 由于每个系统都有很大不同, 指的排除一些锁功能，
因此本规范将锁作为 WebDAV 内协商的唯一轴 (sole axis).

## 6.4. 锁创建者和权限

锁的创建者在使用锁来修改资源时具有特权. 当修改已锁定的资源时,
服务器**必须[MUST]**检查经过身份验证的主体是否与锁创建者匹配 (除了检查有效的锁令牌提交外).

服务器**可以[MAY]**允许除锁创建者之外的特权用户销毁锁 (e.g., 资源所有者或管理员).
[RFC3744] 中定义的 "unlock" 特权提供了该权限.

没有任何要求服务器接受来自所有用户或匿名用户的 LOCK 请求.

需要注意, 拥有锁并不授予对已锁定资源进行全面修改的特权.
写入访问权限和其他特权**必须[MUST]**通过正常的特权或身份验证机制来强制执行,
而不是基于锁令牌值中可能的模糊性.
